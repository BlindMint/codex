workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG
      when: manual
    - when: never

stages:
  - release

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

create_release:
  stage: release
  image: cimg/base:2024.04
  before_script:
    - apt-get update -qq && apt-get install -yq glab jq curl
    - >
      if [ -n "$GITLAB_PAT" ];
      then echo "$GITLAB_PAT" | glab auth login --stdin --token-stdin;
      else glab auth status || echo "Using default job token";
      fi
  script:
    # Extract version from tag (remove 'v' prefix)
    - VERSION="${CI_COMMIT_TAG#v}"

    # Download APK from GitLab Packages (uploaded by release.sh)
    - >
      apk_url="https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/packages/generic/codex/$VERSION/codex-v$VERSION.apk"
      echo "Downloading APK from: $apk_url"
      curl --fail --silent --show-error --header "JOB-TOKEN: $CI_JOB_TOKEN" "$apk_url" --output "codex-v$VERSION.apk"

    # Generate SHA256 checksum
    - sha256sum "codex-v$VERSION.apk" > "codex-v$VERSION.apk.sha256"
    - APK_SHA=$(cat "codex-v$VERSION.apk.sha256" | cut -d' ' -f1)

    # Generate changelog from git log
    - PREV_TAG=$(git describe --tags --abbrev=0 "$(git rev-list --tags --max-count=2 | tail -n1)" 2>/dev/null || echo "HEAD")
    - >
      CHANGELOG=$(git log --pretty=format:"- %s (by %an on %ar)" "$PREV_TAG"..HEAD --max-count=10 2>/dev/null
      || echo "Initial release - no prior commits.")

    # Create release notes
    - >
      echo "Automated Android release for Codex app.

      ## Changelog
      $CHANGELOG

      ## Download
      - APK: codex-v$VERSION.apk (SHA256: $APK_SHA)
      - Install: Enable 'Unknown sources' in Android settings.
      - Full notes: See [compare]($PREV_TAG...$CI_COMMIT_TAG)

      Generated by GitLab CI from release.sh build." > release_notes.md

    # Create GitLab release with assets
    - >
      glab release create "$CI_COMMIT_TAG"
      --title "Release $CI_COMMIT_TAG"
      --description-file release_notes.md
      --draft false
      --prerelease false

    # Upload APK and checksum to release
    - glab release upload "$CI_COMMIT_TAG" "codex-v$VERSION.apk" --name "codex-v$VERSION.apk"
    - glab release upload "$CI_COMMIT_TAG" "codex-v$VERSION.apk.sha256" --name "codex-v$VERSION.apk.sha256"

    # Cleanup
    - rm -f release_notes.md

    - 'echo "Release created at: https://gitlab.com/$CI_PROJECT_PATH/-/releases/$CI_COMMIT_TAG"'
  after_script:
    - echo "GitLab release creation complete."
